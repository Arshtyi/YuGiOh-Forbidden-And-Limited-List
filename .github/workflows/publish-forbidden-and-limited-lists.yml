name: YuGiOh Forbidden and Limited List Data Processing and Release
on:
  schedule:
    - cron: "0 10 * * 1,5"
  #   push:
  #     paths: ".github/workflows/**"
  workflow_dispatch:
jobs:
  process-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          uv sync

      - name: Delete existing release
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: latest
          delete_release: true
          repo: ${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run update_banlist script
        run: |
          uv run main.py

      - name: Compute banlist counts
        id: counts
        run: |
          set -euo pipefail
          echo "Computing banlist counts from ./res/*.json"
          ocg_forbidden=$(jq '(.forbidden // []) | length' ./res/ocg.json)
          ocg_limited=$(jq '(.limited // []) | length' ./res/ocg.json)
          ocg_semi=$(jq '(."semi-limited" // []) | length' ./res/ocg.json)
          ocg_total=$((ocg_forbidden + ocg_limited + ocg_semi))
          tcg_forbidden=$(jq '(.forbidden // []) | length' ./res/tcg.json)
          tcg_limited=$(jq '(.limited // []) | length' ./res/tcg.json)
          tcg_semi=$(jq '(."semi-limited" // []) | length' ./res/tcg.json)
          tcg_total=$((tcg_forbidden + tcg_limited + tcg_semi))
          md_forbidden=$(jq '(.forbidden // []) | length' ./res/md.json)
          md_limited=$(jq '(.limited // []) | length' ./res/md.json)
          md_semi=$(jq '(."semi-limited" // []) | length' ./res/md.json)
          md_total=$((md_forbidden + md_limited + md_semi))
          echo "ocg_forbidden=$ocg_forbidden" >> $GITHUB_OUTPUT
          echo "ocg_limited=$ocg_limited" >> $GITHUB_OUTPUT
          echo "ocg_semi=$ocg_semi" >> $GITHUB_OUTPUT
          echo "ocg_total=$ocg_total" >> $GITHUB_OUTPUT
          echo "tcg_forbidden=$tcg_forbidden" >> $GITHUB_OUTPUT
          echo "tcg_limited=$tcg_limited" >> $GITHUB_OUTPUT
          echo "tcg_semi=$tcg_semi" >> $GITHUB_OUTPUT
          echo "tcg_total=$tcg_total" >> $GITHUB_OUTPUT
          echo "md_forbidden=$md_forbidden" >> $GITHUB_OUTPUT
          echo "md_limited=$md_limited" >> $GITHUB_OUTPUT
          echo "md_semi=$md_semi" >> $GITHUB_OUTPUT
          echo "md_total=$md_total" >> $GITHUB_OUTPUT

      - name: Create directory for tarballs
        run: mkdir -p ./tarballs

      - name: Pack forbidden and limited list
        run: |
          tar -cJf "./tarballs/forbidden_and_limited_list.tar.xz" -C "./res" .
          echo "Created tarball forbidden_and_limited_list.tar.xz with files from res directory"

      - name: Generate checksums for compressed files
        run: |
          mkdir -p ./checksums
          echo "生成 forbidden_and_limited_list.tar.xz 的校验码文件..."
          (cd ./tarballs && sha256sum forbidden_and_limited_list.tar.xz) > ./checksums/forbidden_and_limited_list.tar.xz.sha256

      - name: Create/Update release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: YuGiOh Cards & Banlist Data
          body: |
            爬取[Yugipedia](https://yugipedia.com/wiki/Yugipedia)和[ygocdb](https://ygocdb.com/)自动生成的YuGiOh禁限卡表.

            以下为本次禁限卡表统计：

            | 环境 | 禁止 | 限制 | 准限制 | 总计 |
            |:---:|:---:|:---:|:---:|:---:|
            | OCG | ${{ steps.counts.outputs.ocg_forbidden }} | ${{ steps.counts.outputs.ocg_limited }} | ${{ steps.counts.outputs.ocg_semi }} | ${{ steps.counts.outputs.ocg_total }} |
            | TCG | ${{ steps.counts.outputs.tcg_forbidden }} | ${{ steps.counts.outputs.tcg_limited }} | ${{ steps.counts.outputs.tcg_semi }} | ${{ steps.counts.outputs.tcg_total }} |
            | MD  | ${{ steps.counts.outputs.md_forbidden }} | ${{ steps.counts.outputs.md_limited }} | ${{ steps.counts.outputs.md_semi }} | ${{ steps.counts.outputs.md_total }} |

            压缩包附带对应的SHA-256校验码文件(.sha256).可以使用以下命令验证文件完整性：
            ```
            # 验证SHA-256
            sha256sum -c {filename}.sha256
            ```
            具体参见[YuGiOh-Cards-Maker](https://github.com/Arshtyi/YuGiOh-Cards-Maker)
          files: |
            ./tarballs/forbidden_and_limited_list.tar.xz
            ./checksums/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
